---
import Layout from "../../layouts/Layout.astro";
---

<Layout>
  <main class="admin-page">
    <h2 class="section-title">Halaman Admin Pendaftaran</h2>

    <div class="admin-header">
      <p class="welcome-message">Selamat datang, <strong>Admin DTT</strong></p>
      <div class="header-actions">
        <a href="/admin/events" class="cta-button">Kelola Event</a>
      </div>
      <button id="logout-btn" class="logout-button">Logout</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h4>Total Pendaftar</h4>
        <p id="stat-total">0</p>
      </div>
      <div class="stat-card">
        <h4>Pendaftar Baru</h4>
        <p id="stat-baru">0</p>
      </div>
    </div>

    <div class="admin-controls">
      <input
        type="search"
        id="search-input"
        placeholder="Cari nama atau IG pendaftar..."
      />
    </div>

    <div class="table-container responsive-table">
      <table>
        <thead>
          <tr>
            <th data-sort="created_at">Tanggal Daftar</th>
            <th data-sort="nama_asli">Nama Lengkap</th>
            <th>Instagram</th>
            <th>Nomor Telepon</th>
            <th>Karya</th>
            <th>Alasan Bergabung</th>
          </tr>
        </thead>
        <tbody id="applicants-table-body">
          <tr>
            <td colspan="6">Memuat data pendaftar...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <div id="detail-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal-button">&times;</span>
      <h3 id="modal-nama">Nama Pendaftar</h3>
      <p id="modal-ig" class="modal-subtitle"></p>
      <hr class="modal-divider" />
      <div class="modal-details">
        <p><strong>Tanggal Daftar:</strong> <span id="modal-tanggal"></span></p>
        <p><strong>Nomor Telepon:</strong> <span id="modal-telepon"></span></p>
        <p>
          <strong>Karya:</strong>
          <a href="#" id="modal-karya" target="_blank">Lihat Karya</a>
        </p>
        <p><strong>Alasan Bergabung:</strong></p>
        <p id="modal-alasan" class="modal-reason"></p>
      </div>
    </div>
  </div>
  <div id="logout-modal" class="modal">
    <div class="modal-content">
      <h3>Konfirmasi Logout</h3>
      <p style="margin: 1rem 0 2rem; color: #ccc;">
        Anda yakin ingin keluar dari halaman admin?
      </p>
      <div class="modal-actions">
        <button id="cancel-logout-btn" class="modal-button cancel">Batal</button
        >
        <button id="confirm-logout-btn" class="modal-button confirm-danger"
          >Ya, Logout</button
        >
      </div>
    </div>
  </div>
</Layout>

<script is:inline>
  document.addEventListener("DOMContentLoaded", async () => {
    async function fetchAdminInfo() {
      try {
        const response = await fetch("/api/me");
        if (!response.ok) return; // Gagal, biarkan nama default

        const adminData = await response.json();
        const welcomeMessage = document.querySelector(
          ".welcome-message strong"
        );

        if (welcomeMessage && adminData.real_name) {
          welcomeMessage.textContent = adminData.real_name;
        }
      } catch (error) {
        console.error("Gagal mengambil info admin:", error);
      }
    }

    // Panggil fungsi untuk mengambil info admin saat halaman dimuat
    fetchAdminInfo();

    const logoutBtn = document.getElementById("logout-btn");
    const logoutModal = document.getElementById("logout-modal");
    const cancelLogoutBtn = document.getElementById("cancel-logout-btn");
    const confirmLogoutBtn = document.getElementById("confirm-logout-btn");
    const tableBody = document.getElementById("applicants-table-body");
    const searchInput = document.getElementById("search-input");
    const sortableHeaders = document.querySelectorAll("th[data-sort]");
    const detailModal = document.getElementById("detail-modal");
    const closeModalButton = detailModal.querySelector(".close-modal-button");
    const statTotal = document.getElementById("stat-total");
    const statBaru = document.getElementById("stat-baru");

    if (logoutBtn) {
      // Saat tombol logout utama diklik, BUKA modal
      logoutBtn.addEventListener("click", () => {
        logoutModal.classList.add("active");
      });

      // Saat tombol "Batal" diklik, TUTUP modal
      cancelLogoutBtn.addEventListener("click", () => {
        logoutModal.classList.remove("active");
      });

      logoutModal.addEventListener("click", (e) => {
        if (e.target === logoutModal) {
          logoutModal.classList.remove("active");
        }
      });

      // Saat tombol "Ya, Logout" diklik, panggil API logout
      confirmLogoutBtn.addEventListener("click", async () => {
        // Tampilkan status loading jika perlu
        confirmLogoutBtn.textContent = "Logging out...";
        confirmLogoutBtn.disabled = true;

        // Panggil API untuk logout
        const response = await fetch("/api/logout", { method: "POST" });

        // API akan menangani redirect, tapi kita bisa paksa redirect di sini jika gagal
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          // Jika terjadi error, arahkan manual ke halaman utama
          window.location.href = "/";
        }
      });
    }

    let allApplicants = [];
    let currentSort = { key: "created_at", direction: "desc" };

    function updateStatCards(applicants) {
      // Bagian Total Pendaftar tidak berubah
      statTotal.textContent = applicants.length;

      // --- Logika Baru untuk Pendaftar Hari Ini ---
      const today = new Date();
      // Mengubah tanggal hari ini menjadi format "YYYY-MM-DD" untuk perbandingan
      const todayString = today.toISOString().slice(0, 10);

      const newApplicantsToday = applicants.filter((applicant) => {
        // Mengambil tanggal pendaftaran dari setiap aplikan
        const registrationDateString = new Date(applicant.created_at)
          .toISOString()
          .slice(0, 10);
        // Membandingkan apakah tanggal pendaftaran sama dengan tanggal hari ini
        return registrationDateString === todayString;
      }).length;

      // Update kartu Pendaftar Baru dengan hasil perhitungan
      statBaru.textContent = newApplicantsToday;
    }

    function renderTable(applicantsToRender) {
      tableBody.innerHTML = "";
      if (applicantsToRender.length === 0) {
        tableBody.innerHTML =
          '<tr class="no-hover"><td colspan="6">Tidak Ada Pendaftar Baru.</td></tr>';
        return;
      }
      applicantsToRender.forEach((applicant) => {
        const row = document.createElement("tr");
        row.dataset.applicantId = applicant.id;
        const registrationDate = new Date(
          applicant.created_at
        ).toLocaleDateString("id-ID", {
          day: "numeric",
          month: "long",
          year: "numeric",
        });
        row.innerHTML = `
          <td data-label="Tgl Daftar">${registrationDate}</td>
          <td data-label="Nama">${applicant.nama_asli}</td>
          <td data-label="Instagram"><a href="https://instagram.com/${applicant.nama_ig.replace("@", "")}" target="_blank">${applicant.nama_ig}</a></td>
          <td data-label="Nomor Telepon">${applicant.nomor_telepon || "-"}</td>
          <td data-label="Karya"><a href="${applicant.karya_url}" target="_blank">Lihat Karya</a></td>
          <td data-label="Alasan Bergabug">${applicant.jawaban_lain || "-"}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateView() {
      const searchTerm = searchInput.value.toLowerCase();
      let processedApplicants = allApplicants.filter(
        (applicant) =>
          applicant.nama_asli.toLowerCase().includes(searchTerm) ||
          applicant.nama_ig.toLowerCase().includes(searchTerm)
      );
      processedApplicants.sort((a, b) => {
        const key = currentSort.key;
        if (a[key] < b[key]) return currentSort.direction === "asc" ? -1 : 1;
        if (a[key] > b[key]) return currentSort.direction === "asc" ? 1 : -1;
        return 0;
      });
      renderTable(processedApplicants);
      updateHeaderStyles();
    }

    function updateHeaderStyles() {
      sortableHeaders.forEach((header) => {
        header.classList.remove("sorted-asc", "sorted-desc");
        if (header.dataset.sort === currentSort.key) {
          header.classList.add(
            currentSort.direction === "asc" ? "sorted-asc" : "sorted-desc"
          );
        }
      });
    }

    searchInput.addEventListener("input", updateView);

    sortableHeaders.forEach((header) => {
      header.addEventListener("click", () => {
        const sortKey = header.dataset.sort;
        if (currentSort.key === sortKey) {
          currentSort.direction =
            currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          currentSort.key = sortKey;
          currentSort.direction = "asc";
        }
        updateView();
      });
    });

    tableBody.addEventListener("click", (e) => {
      if (target.closest("tr") && !target.closest("a")) {
        const row = target.closest("tr");
        const applicantId = row.dataset.applicantId;
        const applicant = allApplicants.find((a) => a.id == applicantId);
        if (applicant) {
          document.getElementById("modal-nama").textContent =
            applicant.nama_asli;
          document.getElementById("modal-ig").textContent = applicant.nama_ig;
          document.getElementById("modal-tanggal").textContent = new Date(
            applicant.created_at
          ).toLocaleString("id-ID");
          document.getElementById("modal-telepon").textContent =
            applicant.nomor_telepon || "-";
          document.getElementById("modal-karya").href = applicant.karya_url;
          document.getElementById("modal-alasan").textContent =
            applicant.jawaban_lain || "-";
          detailModal.classList.add("active");
        }
      }
    });

    closeModalButton.addEventListener("click", () =>
      detailModal.classList.remove("active")
    );
    detailModal.addEventListener("click", (e) => {
      if (e.target === detailModal) detailModal.classList.remove("active");
    });

    try {
      const response = await fetch("/api/applicants");
      if (!response.ok) throw new Error("Gagal mengambil data.");
      allApplicants = await response.json();
      updateStatCards(allApplicants);
      updateView();
    } catch (error) {
      tableBody.innerHTML = `<tr class="no-hover"><td colspan="6">Error: ${error.message}</td></tr>`;
    }
  });
</script>
