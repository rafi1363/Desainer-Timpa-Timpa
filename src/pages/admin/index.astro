---
import Layout from "../../layouts/Layout.astro";
---

<Layout>
  <main class="admin-page">
    <h2 class="section-title">Halaman Admin Pendaftaran</h2>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Tanggal Daftar</th>
            <th>Nama Lengkap</th>
            <th>Instagram</th>
            <th>Nomor Telepon</th>
            <th>Mengapa kamu ingin bergabung dengan DTT?</th>
            <th>Karya</th>
          </tr>
        </thead>
        <tbody id="applicants-table-body">
          <tr>
            <td colspan="5">Memuat data pendaftar...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
</Layout>

<style>
  /* ... (style dari sebelumnya, tidak perlu diubah) ... */
  .admin-page {
    padding: 5rem 2rem;
  }
  .table-container {
    max-width: 1200px;
    margin: 0 auto;
    color: #ccc;
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th,
  td {
    padding: 1rem;
    border-bottom: 1px solid #333;
    text-align: left;
    white-space: nowrap;
  }
  th {
    color: var(--color-accent, #f7e479);
  }
  tr:hover {
    background-color: #1a1a1a;
  }
  td a {
    color: var(--color-accent, #f7e479);
    text-decoration: underline;
  }
</style>

<script is:inline>
  // Fungsi ini akan berjalan setelah halaman selesai dimuat
  document.addEventListener("DOMContentLoaded", async () => {
    const tableBody = document.getElementById("applicants-table-body");

    try {
      // 1. Panggil API "kurir" kita
      const response = await fetch("/api/applicants");
      if (!response.ok) {
        throw new Error("Gagal mengambil data dari server.");
      }

      const applicants = await response.json();

      // Kosongkan isi tabel (menghapus pesan "Memuat data...")
      tableBody.innerHTML = "";

      // 2. Jika tidak ada data, tampilkan pesan
      if (applicants.length === 0) {
        tableBody.innerHTML =
          '<tr><td colspan="5">Belum ada pendaftar baru.</td></tr>';
        return;
      }

      // 3. Loop setiap data pendaftar dan buat baris tabel baru
      applicants.forEach((applicant) => {
        const row = document.createElement("tr");

        // Format tanggal agar lebih mudah dibaca
        const registrationDate = new Date(
          applicant.created_at
        ).toLocaleDateString("id-ID", {
          day: "numeric",
          month: "long",
          year: "numeric",
        });

        row.innerHTML = `
          <td>${registrationDate}</td>
          <td>${applicant.nama_asli}</td>
          <td><a href="https://instagram.com/${applicant.nama_ig.replace("@", "")}" target="_blank">${applicant.nama_ig}</a></td>
          <td>${applicant.nomor_telepon || "-"}</td>
          <td><a href="${applicant.karya_url}" target="_blank">Lihat Karya</a></td>
        `;

        tableBody.appendChild(row);
      });
    } catch (error) {
      tableBody.innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`;
      console.error(error);
    }
  });
</script>
