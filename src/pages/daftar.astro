---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <div id="success-message" style="display:none;"></div>
  <main class="registration-page">
    <div class="registration-container">
      <h2 class="section-title">Pendaftaran Anggota Baru DTT</h2>
      <p class="registration-subtitle">
        Isi formulir di bawah ini untuk menjadi bagian dari komunitas. Tim kami
        akan meninjau aplikasimu.
      </p>

      <form id="registration-form" class="registration-form">
        <input type="hidden" id="karya_url" name="karya_url" />
        <div class="form-group">
          <label for="nama_asli">Nama Panggilan/Nama Asli</label>
          <input type="text" id="nama_asli" name="nama_asli" required />
        </div>

        <div class="form-group">
          <label for="nama_ig">Username Instagram</label>
          <input
            type="text"
            id="nama_ig"
            name="nama_ig"
            placeholder="@username"
            required
          />
        </div>

        <div class="form-group">
          <label for="nomor_telepon">Nomor Telepon (WhatsApp)</label>
          <input type="tel" id="nomor_telepon" name="nomor_telepon" />
        </div>

        <div class="form-group">
          <label for="karya">Unggah Satu Karya Terbaikmu</label>
          <input
            type="file"
            id="karya"
            name="karya"
            accept="image/*"
            required
          />
          <small>Format: JPG, PNG, WEBP. Maks: 5MB.</small>
        </div>

        <div class="form-group">
          <label for="jawaban_lain"
            >Mengapa kamu ingin bergabung dengan DTT?</label
          >
          <textarea id="jawaban_lain" name="jawaban_lain" rows="4" required
          ></textarea>
        </div>
        <div class="form-actions">
          <a href="/" class="secondary-button">Kembali</a>
          <button type="submit" class="cta-button">Kirim Pendaftaran</button>
        </div>
      </form>
      <div id="success-message" style="display:none;"></div>
    </div>

    <div id="success-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal-button">&times;</span>
        <h2>Pendaftaran Berhasil!</h2>
        <p>
          Terima kasih telah mendaftar. Langkah terakhir, silakan bergabung ke
          grup WhatsApp di bawah ini untuk menunggu persetujuan admin.
        </p>
        <a
          href="#"
          id="whatsapp-link"
          target="_blank"
          class="cta-button"
          style="margin-top: 1.5rem;">Gabung Grup WhatsApp</a
        >
      </div>
    </div>
  </main>
</Layout>

<script is:inline>
  // Ganti dengan data dari akun Cloudinary Anda
  const CLOUDINARY_CLOUD_NAME = "dsnvmjdni";
  const CLOUDINARY_UPLOAD_PRESET = "hziqmdzw";

  // --- ELEMEN YANG KITA KONTROL ---
  const form = document.getElementById("registration-form");
  const fileInput = document.getElementById("karya");
  const hiddenUrlInput = document.getElementById("karya_url");

  // Ambil referensi ke modal sukses yang baru
  const successModal = document.getElementById("success-modal");
  const whatsappLink = document.getElementById("whatsapp-link");
  const closeModalButton = successModal.querySelector(".close-modal-button");

  // --- FUNGSI UNTUK MENUTUP MODAL ---
  const closeModal = () => {
    successModal.classList.remove("active");
  };

  closeModalButton.addEventListener("click", closeModal);
  successModal.addEventListener("click", (event) => {
    if (event.target === successModal) {
      closeModal();
    }
  });

  // --- EVENT LISTENER UNTUK SUBMIT FORMULIR ---
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = "Mengunggah Karya...";

    const file = fileInput.files[0];
    if (!file) {
      alert("Anda harus memilih file karya untuk diunggah.");
      submitButton.disabled = false;
      submitButton.textContent = "Kirim Pendaftaran";
      return;
    }

    const cloudinaryFormData = new FormData();
    cloudinaryFormData.append("file", file);
    cloudinaryFormData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

    try {
      // Langkah 1: Upload ke Cloudinary
      const cloudinaryRes = await fetch(
        `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
        { method: "POST", body: cloudinaryFormData }
      );
      if (!cloudinaryRes.ok) throw new Error("Gagal mengunggah gambar.");
      const cloudinaryData = await cloudinaryRes.json();
      hiddenUrlInput.value = cloudinaryData.secure_url;

      submitButton.textContent = "Menyimpan Pendaftaran...";

      // Langkah 2: Kirim data ke API kita
      const appFormData = new FormData(form);
      const appRes = await fetch("/api/register", {
        method: "POST",
        body: appFormData,
      });
      const result = await appRes.json();

      if (appRes.ok) {
        // --- PERUBAHAN UTAMA ADA DI SINI ---
        // Alih-alih menyembunyikan form, kita tampilkan modal

        // 1. Atur link WhatsApp di dalam modal
        whatsappLink.href = result.whatsapp_link;

        // 2. Tampilkan modal sukses
        successModal.classList.add("active");

        // 3. Reset form dan tombol untuk pendaftaran berikutnya
        form.reset();
        submitButton.disabled = false;
        submitButton.textContent = "Kirim Pendaftaran";
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      alert("Terjadi kesalahan: " + error.message);
      submitButton.disabled = false;
      submitButton.textContent = "Kirim Pendaftaran";
    }
  });
</script>
